<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>404 No More!, Part III</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
First some header stuff.

<pre><span class='varop'>&gt;</span> <span class='comment'>{-# LANGUAGE DeriveDataTypeable, FlexibleContexts #-}</span>
<span class='varop'>&gt;</span> <span class='keyword'>module</span> <span class='conid'>Main</span> <span class='keyword'>where</span>
</pre>

<pre><span class='varop'>&gt;</span> <span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Concurrent</span>
<span class='varop'>&gt;</span> <span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span><span class='varop'>.</span><span class='conid'>Trans</span>
<span class='varop'>&gt;</span> <span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span><span class='varop'>.</span><span class='conid'>Reader</span>
<span class='varop'>&gt;</span> <span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span><span class='varop'>.</span><span class='conid'>State</span>
<span class='varop'>&gt;</span> <span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Tree</span>
<span class='varop'>&gt;</span> <span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>List</span>
<span class='varop'>&gt;</span> <span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Generics</span>
<span class='varop'>&gt;</span> <span class='keyword'>import</span> <span class='conid'>HAppS</span><span class='varop'>.</span><span class='conid'>Server</span> <span class='varid'>hiding</span> <span class='layout'>(</span><span class='varid'>method</span><span class='layout'>,</span> <span class='varid'>dir</span><span class='layout'>)</span>
<span class='varop'>&gt;</span> <span class='keyword'>import</span> <span class='conid'>Text</span><span class='varop'>.</span><span class='conid'>XHtml</span>
<span class='varop'>&gt;</span> <span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>URI</span>
</pre>
<h1>404 No More!, Part III</h1>
 <p>In this part, we will make some minor modifications to the
 <code>Link</code> monad so that it is more usuable in real world
 applications. These modifications include:</p>
 <ol>
 <li>Make the Link monad be a monad transformer instead, so that we
 can mix in IO and other monads.</li>
 <li>Making the generated links a bit more user and search engine friendly.</li>
 <li>Allow the generated link to be something other than a <code>String</code>.</li>
 </ol>

<pre><span class='varop'>&gt;</span> <span class='keyword'>type</span> <span class='conid'>LinkT</span> <span class='varid'>link</span> <span class='varid'>url</span> <span class='varid'>m</span> <span class='varid'>a</span> <span class='keyglyph'>=</span> <span class='conid'>ReaderT</span> <span class='layout'>(</span><span class='varid'>link</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>url</span><span class='layout'>)</span> <span class='varid'>m</span> <span class='varid'>a</span>
</pre>
<pre><span class='varop'>&gt;</span> <span class='keyword'>type</span> <span class='conid'>Link</span> <span class='keyglyph'>=</span> <span class='conid'>String</span>
</pre>
<pre><span class='varop'>&gt;</span> <span class='varid'>showLink</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>Monad</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>link</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>LinkT</span> <span class='varid'>link</span> <span class='varid'>url</span> <span class='varid'>m</span> <span class='varid'>url</span>
<span class='varop'>&gt;</span> <span class='varid'>showLink</span> <span class='varid'>url</span> <span class='keyglyph'>=</span>
<span class='varop'>&gt;</span>    <span class='keyword'>do</span> <span class='varid'>showF</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>ask</span>
<span class='varop'>&gt;</span>       <span class='varid'>return</span> <span class='layout'>(</span><span class='varid'>showF</span> <span class='varid'>url</span><span class='layout'>)</span>
</pre>

<pre><span class='varop'>&gt;</span> <span class='varid'>nestLink</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='varid'>url2</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>url1</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>LinkT</span> <span class='varid'>url2</span> <span class='varid'>url</span> <span class='varid'>m</span> <span class='varid'>a</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>LinkT</span> <span class='varid'>url1</span> <span class='varid'>url</span> <span class='varid'>m</span> <span class='varid'>a</span>
<span class='varop'>&gt;</span> <span class='varid'>nestLink</span> <span class='varid'>b</span> <span class='keyglyph'>=</span> <span class='varid'>withReaderT</span> <span class='layout'>(</span><span class='varop'>.</span> <span class='varid'>b</span><span class='layout'>)</span>
</pre>

<pre><span class='varop'>&gt;</span> <span class='keyword'>data</span> <span class='conid'>OurSite</span> 
<span class='varop'>&gt;</span>     <span class='keyglyph'>=</span> <span class='conid'>HomePage</span>
<span class='varop'>&gt;</span>     <span class='keyglyph'>|</span> <span class='conid'>MyGallery</span> <span class='conid'>Gallery</span>
<span class='varop'>&gt;</span>     <span class='keyglyph'>|</span> <span class='conid'>YourGallery</span> <span class='conid'>Gallery</span>
<span class='varop'>&gt;</span>       <span class='keyword'>deriving</span> <span class='layout'>(</span><span class='conid'>Data</span><span class='layout'>,</span> <span class='conid'>Typeable</span><span class='layout'>)</span>
</pre>
<pre><span class='varop'>&gt;</span> <span class='keyword'>data</span> <span class='conid'>Gallery</span>
<span class='varop'>&gt;</span>    <span class='keyglyph'>=</span> <span class='conid'>Thumbnails</span> 
<span class='varop'>&gt;</span>    <span class='keyglyph'>|</span> <span class='conid'>ShowImage</span> <span class='conid'>Int</span> <span class='conid'>Size</span>
<span class='varop'>&gt;</span>    <span class='keyword'>deriving</span> <span class='layout'>(</span><span class='conid'>Data</span><span class='layout'>,</span> <span class='conid'>Typeable</span><span class='layout'>)</span>
</pre>
<pre><span class='varop'>&gt;</span> <span class='keyword'>data</span> <span class='conid'>Size</span>
<span class='varop'>&gt;</span>    <span class='keyglyph'>=</span> <span class='conid'>Full</span>
<span class='varop'>&gt;</span>    <span class='keyglyph'>|</span> <span class='conid'>Screen</span>
<span class='varop'>&gt;</span>    <span class='keyword'>deriving</span> <span class='layout'>(</span><span class='conid'>Data</span><span class='layout'>,</span> <span class='conid'>Typeable</span><span class='layout'>,</span> <span class='conid'>Show</span><span class='layout'>)</span>
</pre>

<pre><span class='varop'>&gt;</span> <span class='comment'>-- dummy implementation for didactic purposes</span>
<span class='varop'>&gt;</span> <span class='varid'>gallery</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>Monad</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Gallery</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>LinkT</span> <span class='conid'>Gallery</span> <span class='conid'>Link</span> <span class='varid'>m</span> <span class='conid'>Html</span>
<span class='varop'>&gt;</span> <span class='varid'>gallery</span> <span class='varid'>username</span> <span class='conid'>Thumbnails</span> <span class='keyglyph'>=</span> 
<span class='varop'>&gt;</span>     <span class='keyword'>do</span> <span class='varid'>img1</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>showLink</span> <span class='layout'>(</span><span class='conid'>ShowImage</span> <span class='num'>1</span> <span class='conid'>Full</span><span class='layout'>)</span>
<span class='varop'>&gt;</span>        <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>pageTemplate</span> 
<span class='varop'>&gt;</span>            <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>toHtml</span> <span class='varop'>$</span> <span class='str'>"Showing "</span> <span class='varop'>++</span> <span class='varid'>username</span> <span class='varop'>++</span> <span class='str'>"'s gallery thumbnails."</span><span class='layout'>)</span> <span class='varop'>+++</span> 
<span class='varop'>&gt;</span>             <span class='varid'>br</span> <span class='varop'>+++</span>
<span class='varop'>&gt;</span>             <span class='layout'>(</span><span class='varid'>anchor</span> <span class='layout'>(</span><span class='varid'>toHtml</span> <span class='str'>"image 1"</span><span class='layout'>)</span> <span class='varop'>!</span> <span class='keyglyph'>[</span><span class='varid'>href</span> <span class='varid'>img1</span><span class='keyglyph'>]</span><span class='layout'>)</span><span class='layout'>)</span>
<span class='varop'>&gt;</span> <span class='varid'>gallery</span> <span class='varid'>username</span> <span class='layout'>(</span><span class='conid'>ShowImage</span> <span class='varid'>i</span> <span class='varid'>s</span><span class='layout'>)</span> <span class='keyglyph'>=</span> 
<span class='varop'>&gt;</span>     <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>pageTemplate</span> <span class='layout'>(</span><span class='varid'>toHtml</span> <span class='varop'>$</span> <span class='str'>"showing "</span> <span class='varop'>++</span> <span class='varid'>username</span> <span class='varop'>++</span> <span class='str'>"'s image number "</span> <span class='varop'>++</span> 
<span class='varop'>&gt;</span>                            <span class='varid'>show</span> <span class='varid'>i</span> <span class='varop'>++</span> <span class='str'>" at "</span> <span class='varop'>++</span> <span class='varid'>show</span> <span class='varid'>s</span> <span class='varop'>++</span> <span class='str'>" size."</span><span class='layout'>)</span>
</pre>
<pre><span class='varop'>&gt;</span> <span class='varid'>pageTemplate</span> <span class='keyglyph'>::</span> <span class='conid'>Html</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Html</span>
<span class='varop'>&gt;</span> <span class='varid'>pageTemplate</span> <span class='varid'>thebody</span> <span class='keyglyph'>=</span>
<span class='varop'>&gt;</span>     <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>header</span> 
<span class='varop'>&gt;</span>       <span class='layout'>(</span><span class='varid'>thetitle</span> <span class='layout'>(</span><span class='varid'>toHtml</span> <span class='str'>"Simple Site"</span><span class='layout'>)</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varop'>+++</span>
<span class='varop'>&gt;</span>      <span class='layout'>(</span><span class='varid'>body</span> <span class='varid'>thebody</span><span class='layout'>)</span><span class='layout'>)</span>
</pre>

<pre><span class='varop'>&gt;</span> <span class='varid'>ourSite</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>Monad</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>OurSite</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>LinkT</span> <span class='conid'>OurSite</span> <span class='conid'>Link</span> <span class='varid'>m</span> <span class='conid'>Html</span>
<span class='varop'>&gt;</span> <span class='varid'>ourSite</span> <span class='conid'>HomePage</span> <span class='keyglyph'>=</span>
<span class='varop'>&gt;</span>     <span class='keyword'>do</span> <span class='varid'>myGallery</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>showLink</span> <span class='varop'>$</span> <span class='conid'>MyGallery</span> <span class='conid'>Thumbnails</span>
<span class='varop'>&gt;</span>        <span class='varid'>yourGallery</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>nestLink</span> <span class='conid'>YourGallery</span> <span class='varop'>$</span> <span class='varid'>showLink</span> <span class='conid'>Thumbnails</span>
<span class='varop'>&gt;</span>        <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>pageTemplate</span> <span class='layout'>(</span><span class='varid'>toHtml</span> <span class='str'>"go to "</span> <span class='varop'>+++</span> <span class='varid'>br</span> <span class='varop'>+++</span>
<span class='varop'>&gt;</span>                          <span class='layout'>(</span><span class='varid'>anchor</span> <span class='layout'>(</span><span class='varid'>toHtml</span> <span class='str'>"my gallery"</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varop'>!</span> <span class='keyglyph'>[</span><span class='varid'>href</span> <span class='varid'>myGallery</span> <span class='keyglyph'>]</span>  <span class='varop'>+++</span> <span class='varid'>br</span> <span class='varop'>+++</span>
<span class='varop'>&gt;</span>                          <span class='layout'>(</span><span class='varid'>anchor</span> <span class='layout'>(</span><span class='varid'>toHtml</span> <span class='str'>"your gallery"</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varop'>!</span> <span class='keyglyph'>[</span><span class='varid'>href</span> <span class='varid'>yourGallery</span> <span class='keyglyph'>]</span> 
<span class='varop'>&gt;</span>                         <span class='layout'>)</span>
<span class='varop'>&gt;</span> <span class='varid'>ourSite</span> <span class='layout'>(</span><span class='conid'>MyGallery</span> <span class='varid'>g</span><span class='layout'>)</span> <span class='keyglyph'>=</span>
<span class='varop'>&gt;</span>     <span class='varid'>nestLink</span> <span class='conid'>MyGallery</span> <span class='varop'>$</span> <span class='varid'>gallery</span> <span class='str'>"Jeremy Shaw"</span> <span class='varid'>g</span>
<span class='varop'>&gt;</span> <span class='varid'>ourSite</span> <span class='layout'>(</span><span class='conid'>YourGallery</span> <span class='varid'>g</span><span class='layout'>)</span> <span class='keyglyph'>=</span>
<span class='varop'>&gt;</span>     <span class='varid'>nestLink</span> <span class='conid'>YourGallery</span> <span class='varop'>$</span> <span class='varid'>gallery</span> <span class='str'>"someone else"</span> <span class='varid'>g</span>
</pre>

<pre><span class='varop'>&gt;</span>
<span class='varop'>&gt;</span> <span class='keyword'>data</span> <span class='conid'>Site</span> <span class='varid'>link</span> <span class='varid'>url</span> <span class='varid'>m</span> <span class='varid'>a</span>
<span class='varop'>&gt;</span>     <span class='keyglyph'>=</span> <span class='conid'>Site</span> <span class='layout'>{</span> <span class='varid'>handleLink</span>  <span class='keyglyph'>::</span> <span class='varid'>link</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>LinkT</span> <span class='varid'>link</span> <span class='varid'>url</span> <span class='varid'>m</span> <span class='varid'>a</span>
<span class='varop'>&gt;</span>            <span class='layout'>,</span> <span class='varid'>defaultPage</span> <span class='keyglyph'>::</span> <span class='varid'>link</span>
<span class='varop'>&gt;</span>            <span class='layout'>,</span> <span class='varid'>formatLink</span>  <span class='keyglyph'>::</span> <span class='varid'>link</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>url</span>
<span class='varop'>&gt;</span>            <span class='layout'>,</span> <span class='varid'>parseLink</span>   <span class='keyglyph'>::</span> <span class='varid'>url</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Maybe</span> <span class='varid'>link</span> 
<span class='varop'>&gt;</span>            <span class='layout'>}</span>
</pre>

<pre><span class='varop'>&gt;</span> <span class='comment'>-- runSite :: (Monad m) =&gt; Site link Link m a -&gt; Link -&gt; m (Maybe a)</span>
<span class='varop'>&gt;</span> <span class='varid'>runSite</span> <span class='varid'>site</span> <span class='varid'>linkStr</span> <span class='keyglyph'>=</span>
<span class='varop'>&gt;</span>     <span class='keyword'>let</span> <span class='varid'>mLink</span> <span class='keyglyph'>=</span> 
<span class='varop'>&gt;</span>             <span class='keyword'>case</span> <span class='varid'>linkStr</span> <span class='keyword'>of</span>
<span class='varop'>&gt;</span>                  <span class='str'>""</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Just</span> <span class='layout'>(</span><span class='varid'>defaultPage</span> <span class='varid'>site</span><span class='layout'>)</span>
<span class='varop'>&gt;</span>                  <span class='keyword'>_</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='varid'>parseLink</span> <span class='varid'>site</span><span class='layout'>)</span> <span class='varid'>linkStr</span>
<span class='varop'>&gt;</span>     <span class='keyword'>in</span>
<span class='varop'>&gt;</span>       <span class='keyword'>case</span> <span class='varid'>mLink</span> <span class='keyword'>of</span>
<span class='varop'>&gt;</span>         <span class='conid'>Nothing</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='conid'>Nothing</span>
<span class='varop'>&gt;</span>         <span class='layout'>(</span><span class='conid'>Just</span> <span class='varid'>lnk</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='varop'>.</span> <span class='conid'>Just</span> <span class='varop'>=&lt;&lt;</span> <span class='varid'>runReaderT</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>handleLink</span> <span class='varid'>site</span><span class='layout'>)</span> <span class='varid'>lnk</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>formatLink</span> <span class='varid'>site</span><span class='layout'>)</span>
</pre>

<pre><span class='varop'>&gt;</span> <span class='varid'>ourSiteSpec</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>Monad</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>Site</span> <span class='conid'>OurSite</span> <span class='conid'>Link</span> <span class='varid'>m</span> <span class='conid'>Html</span>
<span class='varop'>&gt;</span> <span class='varid'>ourSiteSpec</span> <span class='keyglyph'>=</span>
<span class='varop'>&gt;</span>     <span class='conid'>Site</span> <span class='layout'>{</span> <span class='varid'>handleLink</span> <span class='keyglyph'>=</span> <span class='varid'>ourSite</span>
<span class='varop'>&gt;</span>          <span class='layout'>,</span> <span class='varid'>defaultPage</span> <span class='keyglyph'>=</span> <span class='conid'>HomePage</span>
<span class='varop'>&gt;</span>          <span class='layout'>,</span> <span class='varid'>formatLink</span> <span class='keyglyph'>=</span> <span class='varid'>prettyFormatLink</span> <span class='comment'>-- escapeURIString isUnescapedInURI . show</span>
<span class='varop'>&gt;</span>          <span class='layout'>,</span> <span class='varid'>parseLink</span> <span class='keyglyph'>=</span> <span class='varid'>prettyParseLink</span> <span class='comment'>-- readLink</span>
<span class='varop'>&gt;</span>          <span class='layout'>}</span>
</pre>

<pre><span class='varop'>&gt;</span> <span class='varid'>prettyFormatLink</span> <span class='keyglyph'>::</span> <span class='conid'>Data</span> <span class='varid'>a</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>a</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Link</span>
<span class='varop'>&gt;</span> <span class='varid'>prettyFormatLink</span> <span class='varid'>t</span> <span class='keyglyph'>=</span>
<span class='varop'>&gt;</span>     <span class='keyword'>let</span> <span class='varid'>args</span> <span class='keyglyph'>=</span> <span class='varid'>gmapQ</span> <span class='varid'>prettyFormatLink</span> <span class='varid'>t</span>
<span class='varop'>&gt;</span>     <span class='keyword'>in</span> <span class='varid'>encode</span> <span class='varop'>$</span>
<span class='varop'>&gt;</span>     <span class='str'>"/"</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>replicate</span> <span class='layout'>(</span><span class='varid'>length</span> <span class='varid'>args</span><span class='layout'>)</span> <span class='chr'>'!'</span><span class='layout'>)</span> 
<span class='varop'>&gt;</span>         <span class='varop'>++</span> <span class='varid'>showConstr</span> <span class='layout'>(</span><span class='varid'>toConstr</span> <span class='varid'>t</span><span class='layout'>)</span>
<span class='varop'>&gt;</span>         <span class='varop'>++</span> <span class='varid'>concat</span> <span class='varid'>args</span>
<span class='varop'>&gt;</span>     <span class='keyword'>where</span>
<span class='varop'>&gt;</span>       <span class='varid'>encode</span> <span class='keyglyph'>=</span> <span class='varid'>escapeURIString</span> <span class='varid'>isUnescapedInURI</span>
</pre>
<pre><span class='varop'>&gt;</span> <span class='varid'>prettyParseLink</span> <span class='keyglyph'>::</span> <span class='conid'>Data</span> <span class='varid'>a</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>Link</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Maybe</span> <span class='varid'>a</span>
<span class='varop'>&gt;</span> <span class='varid'>prettyParseLink</span> <span class='varid'>str</span> <span class='keyglyph'>=</span>
<span class='varop'>&gt;</span>     <span class='varid'>rewrite</span> <span class='varid'>str</span>
<span class='varop'>&gt;</span>     <span class='keyword'>where</span>
<span class='varop'>&gt;</span>       <span class='varid'>rewrite</span> <span class='varid'>s</span> <span class='keyglyph'>=</span> 
<span class='varop'>&gt;</span>           <span class='keyword'>case</span> <span class='varid'>gread</span> <span class='varop'>$</span> <span class='varid'>toParens</span> <span class='layout'>(</span><span class='varid'>evalState</span> <span class='varid'>toTree</span> <span class='layout'>(</span><span class='varid'>map</span> <span class='varid'>args</span> <span class='layout'>(</span><span class='varid'>words</span> <span class='layout'>(</span><span class='varid'>map</span> <span class='varid'>toSpace</span> <span class='layout'>(</span><span class='varid'>decode</span> <span class='varid'>s</span><span class='layout'>)</span><span class='layout'>)</span><span class='layout'>)</span><span class='layout'>)</span> <span class='layout'>)</span> <span class='keyword'>of</span>
<span class='varop'>&gt;</span>             <span class='keyglyph'>[</span><span class='layout'>(</span><span class='varid'>v</span><span class='layout'>,</span> <span class='str'>""</span><span class='layout'>)</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Just</span> <span class='varid'>v</span>
<span class='varop'>&gt;</span>             <span class='keyword'>_</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Nothing</span>
<span class='varop'>&gt;</span>       <span class='varid'>toSpace</span> <span class='chr'>'/'</span> <span class='keyglyph'>=</span> <span class='chr'>' '</span>
<span class='varop'>&gt;</span>       <span class='varid'>toSpace</span> <span class='varid'>o</span> <span class='keyglyph'>=</span> <span class='varid'>o</span>
<span class='varop'>&gt;</span>       <span class='varid'>args</span> <span class='varid'>argStr</span> <span class='keyglyph'>=</span>
<span class='varop'>&gt;</span>           <span class='keyword'>let</span> <span class='layout'>(</span><span class='varid'>pluses</span><span class='layout'>,</span> <span class='varid'>rest</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>span</span> <span class='layout'>(</span><span class='varop'>==</span> <span class='chr'>'!'</span><span class='layout'>)</span> <span class='varid'>argStr</span>
<span class='varop'>&gt;</span>           <span class='keyword'>in</span> <span class='layout'>(</span><span class='varid'>length</span> <span class='varid'>pluses</span><span class='layout'>,</span> <span class='varid'>rest</span><span class='layout'>)</span>
<span class='varop'>&gt;</span>       <span class='varid'>toTree</span> <span class='keyglyph'>::</span> <span class='conid'>State</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='conid'>Int</span><span class='layout'>,</span> <span class='conid'>String</span><span class='layout'>)</span><span class='keyglyph'>]</span> <span class='layout'>(</span><span class='conid'>Tree</span> <span class='conid'>String</span><span class='layout'>)</span>
<span class='varop'>&gt;</span>       <span class='varid'>toTree</span> <span class='keyglyph'>=</span> 
<span class='varop'>&gt;</span>           <span class='keyword'>do</span> <span class='layout'>(</span><span class='varid'>argCount</span><span class='layout'>,</span> <span class='varid'>constr</span><span class='layout'>)</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>next</span>
<span class='varop'>&gt;</span>              <span class='varid'>args</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>replicateM</span> <span class='varid'>argCount</span> <span class='varid'>toTree</span>
<span class='varop'>&gt;</span>              <span class='varid'>return</span> <span class='varop'>$</span> <span class='conid'>Node</span> <span class='varid'>constr</span> <span class='varid'>args</span>
<span class='varop'>&gt;</span>       <span class='varid'>toParens</span> <span class='layout'>(</span><span class='conid'>Node</span> <span class='varid'>constr</span> <span class='varid'>args</span><span class='layout'>)</span> <span class='keyglyph'>=</span>
<span class='varop'>&gt;</span>           <span class='str'>"("</span> <span class='varop'>++</span> <span class='varid'>constr</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>concatMap</span> <span class='layout'>(</span><span class='layout'>(</span><span class='str'>" "</span> <span class='varop'>++</span><span class='layout'>)</span> <span class='varop'>.</span> <span class='varid'>toParens</span><span class='layout'>)</span> <span class='varid'>args</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>")"</span>
<span class='varop'>&gt;</span>       <span class='varid'>decode</span> <span class='keyglyph'>=</span> <span class='varid'>unEscapeString</span>
<span class='varop'>&gt;</span>       <span class='varid'>next</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>MonadState</span> <span class='keyglyph'>[</span><span class='varid'>s</span><span class='keyglyph'>]</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>m</span> <span class='varid'>s</span>
<span class='varop'>&gt;</span>       <span class='varid'>next</span> <span class='keyglyph'>=</span> 
<span class='varop'>&gt;</span>           <span class='keyword'>do</span> <span class='layout'>(</span><span class='varid'>x</span><span class='conop'>:</span><span class='varid'>xs</span><span class='layout'>)</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>get</span>
<span class='varop'>&gt;</span>              <span class='varid'>put</span> <span class='varid'>xs</span>
<span class='varop'>&gt;</span>              <span class='varid'>return</span> <span class='varid'>x</span>
</pre>

<pre><span class='varop'>&gt;</span> <span class='comment'>-- * Boilerplate code for running ourSite via HAppS. </span>
<span class='varop'>&gt;</span> <span class='comment'>-- Easily adaptable to Network.CGI, etc.</span>
</pre>
<pre><span class='varop'>&gt;</span> <span class='varid'>implURL</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='conid'>ServerPartT</span> <span class='conid'>IO</span> <span class='conid'>Response</span><span class='keyglyph'>]</span>
<span class='varop'>&gt;</span> <span class='varid'>implURL</span> <span class='keyglyph'>=</span>
<span class='varop'>&gt;</span>     <span class='keyglyph'>[</span> <span class='varid'>withRequest</span> <span class='varop'>$</span> <span class='keyglyph'>\</span><span class='varid'>rq</span> <span class='keyglyph'>-&gt;</span>
<span class='varop'>&gt;</span>           <span class='keyword'>let</span> <span class='varid'>link</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>concat</span> <span class='layout'>(</span><span class='varid'>intersperse</span> <span class='str'>"/"</span> <span class='layout'>(</span><span class='varid'>rqPaths</span> <span class='varid'>rq</span><span class='layout'>)</span><span class='layout'>)</span><span class='layout'>)</span>
<span class='varop'>&gt;</span>           <span class='keyword'>in</span>
<span class='varop'>&gt;</span>             <span class='keyword'>do</span> <span class='varid'>lift</span> <span class='varop'>$</span> <span class='varid'>print</span> <span class='varid'>link</span>
<span class='varop'>&gt;</span>                <span class='varid'>return</span> <span class='varop'>.</span> <span class='varid'>toResponse</span> <span class='varop'>=&lt;&lt;</span> <span class='varid'>runSite</span> <span class='varid'>ourSiteSpec</span> <span class='varid'>link</span>
<span class='varop'>&gt;</span>     <span class='keyglyph'>]</span>
</pre>
<pre><span class='varop'>&gt;</span> <span class='varid'>main</span> <span class='keyglyph'>::</span> <span class='conid'>IO</span> <span class='conid'>()</span>
<span class='varop'>&gt;</span> <span class='varid'>main</span> <span class='keyglyph'>=</span> 
<span class='varop'>&gt;</span>     <span class='keyword'>do</span> <span class='varid'>tid</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>forkIO</span> <span class='varop'>$</span> <span class='varid'>simpleHTTP</span> <span class='varid'>nullConf</span> <span class='varid'>implURL</span>
<span class='varop'>&gt;</span>        <span class='varid'>putStrLn</span> <span class='str'>"running..."</span>
<span class='varop'>&gt;</span>        <span class='varid'>waitForTermination</span>
<span class='varop'>&gt;</span>        <span class='varid'>killThread</span> <span class='varid'>tid</span>
<span class='varop'>&gt;</span>
</pre>